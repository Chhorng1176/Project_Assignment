{% extends "layouts/farmer_base.html" %}
{% block title %}Diagnosis Result{% endblock %}

{% block content %}
<div class="flex-grow-1 d-flex flex-column">

    <!-- ===============================
         HEADER
    =============================== -->
    <div class="border-bottom bg-white px-4 py-3">
        <h5 class="mb-0 text-success">
            üå± Diagnosis Result
        </h5>
    </div>

    <!-- ===============================
         CHATGPT-STYLE CONTENT
    =============================== -->
    <div class="flex-grow-1 overflow-auto p-4">

        <!-- ===============================
             FARMER INPUT (USER MESSAGE)
        =============================== -->
        <div class="d-flex justify-content-end mb-4">
            <div class="bg-success text-white p-3 rounded"
                 style="max-width:70%;">
                <strong>üßë‚Äçüåæ Farmer Symptoms</strong>
                <hr class="my-2 bg-white">
                {{ diagnosis.symptoms }}
            </div>
        </div>

        <!-- ===============================
             SYSTEM / AI RESPONSE
        =============================== -->
        <div class="d-flex justify-content-start mb-4">
            <div class="bg-white border rounded shadow-sm p-3"
                 style="max-width:70%;">

                <strong class="text-success">
                    ü§ñ System Diagnosis
                </strong>
                <hr class="my-2">

                <p class="mb-2">
                    <strong>Crop:</strong>
                    {{ diagnosis.crop_name }}
                </p>

                {% if diagnosis.disease_name and diagnosis.disease_name != "Unknown" %}
                    <p class="mb-2">
                        <strong>Detected Disease:</strong>
                        <span class="text-danger">
                            {{ diagnosis.disease_name }}
                        </span>
                    </p>

                    {% if diagnosis.confidence %}
                        <p class="mb-2">
                            <strong>Confidence:</strong>
                            {{ (diagnosis.confidence * 100)|round(1) }}%
                        </p>
                    {% endif %}

                    <p class="text-muted mb-0">
                        This diagnosis was generated automatically
                        using the rule-based expert system.
                    </p>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        ‚ùì No disease could be confidently detected
                        based on the provided symptoms.
                    </div>
                {% endif %}

            </div>
        </div>

        <!-- ===============================
             EXPERT RESPONSE (HUMAN-IN-THE-LOOP)
        =============================== -->
        <div class="d-flex justify-content-start mb-4">
            <div class="bg-light border rounded p-3"
                 style="max-width:70%;">

                <strong class="text-primary">
                    üßë‚Äç‚öïÔ∏è Expert Review
                </strong>
                <hr class="my-2">

                {% if diagnosis.status == "APPROVED" %}
                    <span class="badge badge-success mb-2">
                        Approved by Expert
                    </span>

                    {% if diagnosis.solution %}
                        <p class="mt-2" style="white-space: pre-line;">
                            {{ diagnosis.solution }}
                        </p>
                    {% else %}
                        <p class="text-muted mb-0">
                            Expert approved this diagnosis without
                            additional notes.
                        </p>
                    {% endif %}

                {% elif diagnosis.status == "REJECTED" %}
                    <span class="badge badge-danger mb-2">
                        Rejected by Expert
                    </span>

                    <p class="text-danger mb-0">
                        ‚ùå This diagnosis was rejected by the expert.
                        Please submit a new diagnosis or ask the expert directly.
                    </p>

                {% else %}
                    <span class="badge badge-warning mb-2">
                        Pending Expert Review
                    </span>

                    <p class="text-muted mb-0">
                        ‚è≥ Your diagnosis is waiting for expert verification.
                    </p>
                {% endif %}

            </div>
        </div>

    </div>

    <!-- ===============================
         FOOTER ACTIONS
    =============================== -->
    <div class="border-top bg-light px-4 py-3 d-flex justify-content-between">
        <a href="{{ url_for('farmer.diagnose') }}"
           class="btn btn-outline-success btn-sm">
            ‚ûï New Diagnosis
        </a>

        <a href="{{ url_for('farmer.chat') }}"
           class="btn btn-success btn-sm">
            üí¨ Ask Expert
        </a>
    </div>

</div>
{% endblock %}
